<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alloha - Cacti Facti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: linear-gradient(135deg, #FDFCFB 0%, #E2D1C3 100%);
            --card: rgba(255, 255, 255, 0.85);
            --text: #5D4037;
            --text-secondary: #8D6E63;
            --accent: #E57373;
            --accent-light: rgba(229, 115, 115, 0.1);
            --accent-gradient: linear-gradient(135deg, #E57373 0%, #FF8A65 100%);
            --stuck-block: linear-gradient(135deg, #757575 0%, #616161 100%);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-soft: 0 6px 20px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 12px 40px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 20px 60px rgba(0, 0, 0, 0.10);
            --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-quick: cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .themed-button {
            font-weight: 600; border-radius: 12px; transition: all 0.3s var(--ease-smooth);
            border: none; position: relative; overflow: hidden; transform-origin: center;
        }
        .themed-button:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        .themed-button:active { transform: scale(0.98); transition-duration: 0.1s; }
        
        .glass-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.3) 100%); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: var(--shadow-soft), 0 0 0 1px var(--glass-border), inset 0 1px 0 rgba(255, 255, 255, 0.3); border: none !important; transition: all 0.3s var(--ease-smooth); position: relative; overflow: hidden;
        }
        .grid-cell {
            aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: clamp(1.2rem, 5.5vw, 2.75rem);
            transition: all 0.3s var(--ease-smooth); background: #FAF8F5;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            position: relative; overflow: hidden; min-width: 40px; min-height: 40px;
        }
        .themed-modal { border-radius: 20px; background: var(--card); box-shadow: var(--shadow-strong); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); }
        
        .progress-bar-container { position: relative; overflow: hidden; background: rgba(229, 115, 115, 0.15); border-radius: 9999px; }
        .progress-bar-fill { background: var(--accent-gradient); position: relative; overflow: hidden; transition: width 0.3s var(--ease-smooth); height: 100%; }
        .progress-bar-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.6) 50%, transparent 100%); animation: progress-shimmer 2s infinite; }
        @keyframes progress-shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        @keyframes dice-tumble {
            0%   { transform: rotate(0deg) scale(1); filter: blur(0px); }
            25%  { transform: rotate(-90deg) scale(1.05); }
            50%  { transform: rotate(-180deg) scale(1.1); filter: blur(3px); }
            75%  { transform: rotate(-270deg) scale(1.05); }
            100% { transform: rotate(-360deg) scale(1); filter: blur(0px); }
        }
        .dice-tumble {
            animation: dice-tumble 0.6s var(--ease-bounce);
        }
        .shake-animation { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-3deg); } 75% { transform: translateX(5px) rotate(3deg); } }

        .modal { transition: all 0.3s var(--ease-smooth); }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content { transition: all 0.3s var(--ease-smooth); }
        .modal.is-open .modal-content { transform: scale(1) translateY(0); }
        
        .superpower-btn { background: transparent; border: none; box-shadow: none; color: var(--text-secondary); font-weight: 500; border-radius: 12px; padding: 4px; font-size: 0.7rem; text-align: center; transition: all 0.3s ease; cursor: pointer; min-width: 50px; line-height: 1.2; }
        .superpower-btn:hover:not(:disabled) { transform: translateY(-2px); text-decoration: underline; background: rgba(229, 115, 115, 0.1); }
        .superpower-btn--active { font-weight: 700; transform: translateY(-2px) !important; background: rgba(229, 115, 115, 0.2); }
        .superpower-btn:disabled { opacity: 0.5; cursor: not-allowed; text-decoration: none; }
        
        #close-rules-btn, #close-game-over-btn, #close-edition-select-btn, #confirm-cancel-btn { color: var(--text-secondary); }
        #close-rules-btn:hover, #close-game-over-btn:hover, #close-edition-select-btn:hover, #confirm-cancel-btn:hover { color: var(--text); background-color: var(--accent-light); }
        
        .score-display-cell { 
            background: #FAF8F5 !important; 
            color: var(--text-secondary);
            font-size: clamp(1rem, 4vw, 1.5rem);
        }
        .highlighted { background-color: rgba(76, 175, 80, 0.15); border: 1px solid rgba(76, 175, 80, 0.3); box-shadow: 0 0 8px rgba(76, 175, 80, 0.2); animation: pulse-highlight 2s infinite; }
        @keyframes pulse-highlight { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); } 70% { box-shadow: 0 0 0 4px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
        
        .alloha-logo { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .alloha-logo svg { width: 100%; height: 100%; }
        .alloha-logo svg path, .alloha-logo svg g { fill: var(--accent) !important; }
    </style>
</head>
<body class="p-2 lg:p-4">
    <audio id="audio-unlocker" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=" preload="auto"></audio>
    <main id="game-container" class="w-full max-w-5xl mx-auto flex flex-col lg:flex-row gap-4 lg:gap-6 items-center lg:items-stretch pt-8 lg:pt-16">
        <div class="w-full lg:w-2/3 relative">
            <div id="effects-container" class="absolute inset-0 pointer-events-none z-10 overflow-hidden"></div>
            <div id="game-board-container" class="p-2 lg:p-6 rounded-card shadow-lg h-full">
                <div class="grid grid-cols-8 gap-1 lg:gap-3 h-full">
                    <div id="game-board" class="col-span-7 grid grid-cols-7 gap-1 lg:gap-2"></div>
                    <div id="row-scores-display" class="col-span-1 grid grid-rows-7 gap-1 lg:gap-2"></div>
                    <div id="col-scores-display" class="col-span-7 grid grid-cols-7 mt-1 lg:mt-0 gap-1 lg:gap-2"></div>
                    <div class="flex items-center justify-center p-1">
                        <div class="alloha-logo">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" zoomAndPan="magnify" viewBox="0 0 396.75 396.749985" preserveAspectRatio="xMidYMid meet" version="1.0"><defs><clipPath id="864cd2432c"><path d="M 40 0 L 355 0 L 355 396.5 L 40 396.5 Z M 40 0 " clip-rule="nonzero"/></clipPath><clipPath id="9e91a8b430"><rect x="0" width="169" y="0" height="269"/></clipPath><clipPath id="9a4060e8fa"><path d="M 146 116 L 314.976562 116 L 314.976562 396.5 L 146 396.5 Z M 146 116 " clip-rule="nonzero"/></clipPath><clipPath id="f5a1301079"><rect x="0" width="169" y="0" height="281"/></clipPath><clipPath id="45fb35c46f"><rect x="0" width="166" y="0" height="269"/></clipPath><clipPath id="cd05768fb1"><path d="M 0.292969 116 L 171 116 L 171 396.5 L 0.292969 396.5 Z M 0.292969 116 " clip-rule="nonzero"/></clipPath><clipPath id="f5e8ebd13e"><rect x="0" width="171" y="0" height="281"/></clipPath><clipPath id="22bb000506"><path d="M 242.375 20.429688 L 285.164062 20.429688 L 285.164062 140.25 L 242.375 140.25 Z M 242.375 20.429688 " clip-rule="nonzero"/></clipPath><clipPath id="cb13c63ddb"><path d="M 0.375 0.429688 L 43.164062 0.429688 L 43.164062 120.25 L 0.375 120.25 Z M 0.375 0.429688 " clip-rule="nonzero"/></clipPath><clipPath id="7703948ec8"><rect x="0" width="44" y="0" height="121"/></clipPath><clipPath id="0f7bc66451"><path d="M 213.839844 20.4375 L 276.609375 20.4375 L 276.609375 63.222656 L 213.839844 63.222656 Z M 213.839844 20.4375 " clip-rule="nonzero"/></clipPath><clipPath id="90aa4af11e"><path d="M 0.839844 0.4375 L 63.609375 0.4375 L 63.609375 43.222656 L 0.839844 43.222656 Z M 0.839844 0.4375 " clip-rule="nonzero"/></clipPath><clipPath id="75d75e67e1"><rect x="0" width="64" y="0" height="44"/></clipPath><clipPath id="e5df82bf12"><rect x="0" width="315" y="0" height="397"/></clipPath></defs><g clip-path="url(#864cd2432c)"><g transform="matrix(1, 0, 0, 1, 40, 0)"><g clip-path="url(#e5df82bf12)"><g transform="matrix(1, 0, 0, 1, 1, 0)"><g clip-path="url(#9e91a8b430)"><g fill="#000000" fill-opacity="1"><g transform="translate(0.873977, 194.870819)"><g><path d="M 137.910156 0 L 137.910156 -174.546875 L 6.804688 -174.546875 L 6.804688 0 L 50.503906 0 L 50.503906 -48.675781 L 94.207031 -48.675781 L 94.207031 0 Z M 94.207031 -88.449219 L 50.503906 -88.449219 L 50.503906 -134.507812 L 94.207031 -134.507812 Z M 94.207031 -88.449219 "/></g></g></g></g></g><g clip-path="url(#9a4060e8fa)"><g transform="matrix(1, 0, 0, 1, 146, 116)"><g clip-path="url(#f5a1301079)"><g fill="#000000" fill-opacity="1"><g transform="translate(1.206642, 267.950498)"><g><path d="M 137.910156 0 L 137.910156 -174.546875 L 6.804688 -174.546875 L 6.804688 0 Z M 94.207031 -39.777344 L 50.503906 -39.777344 L 50.503906 -134.507812 L 94.207031 -134.507812 Z M 94.207031 -39.777344 "/></g></g></g></g></g></g><g transform="matrix(1, 0, 0, 1, 148, 0)"><g clip-path="url(#45fb35c46f)"><g fill="#000000" fill-opacity="1"><g transform="translate(0.26582, 194.870819)"><g><path d="M 137.386719 0 L 137.386719 -39.777344 L 50.503906 -39.777344 L 50.503906 -174.546875 L 6.804688 -174.546875 L 6.804688 0 Z M 137.386719 0 "/></g></g></g></g></g><g clip-path="url(#cd05768fb1)"><g transform="matrix(1, 0, 0, 1, -0.000000000000007105, 116)"><g clip-path="url(#f5e8ebd13e)"><g fill="#000000" fill-opacity="1"><g transform="translate(1.876102, 267.950498)"><g><path d="M 137.910156 0 L 137.910156 -174.546875 L 94.207031 -174.546875 L 94.207031 -107.03125 L 50.503906 -107.03125 L 50.503906 -174.546875 L 6.804688 -174.546875 L 6.804688 0 L 50.503906 0 L 50.503906 -68.5625 L 94.207031 -68.5625 L 94.207031 0 Z M 137.910156 0 "/></g></g></g></g></g></g><g clip-path="url(#22bb000506)"><g transform="matrix(1, 0, 0, 1, 242, 20)"><g clip-path="url(#7703948ec8)"><g clip-path="url(#cb13c63ddb)"><path fill="#000000" d="M 43.164062 120.25 L 0.375 120.25 L 0.375 0.414062 L 43.164062 0.414062 Z M 43.164062 120.25 " fill-opacity="1" fill-rule="nonzero"/></g></g></g></g><g clip-path="url(#0f7bc66451)"><g transform="matrix(1, 0, 0, 1, 213, 20)"><g clip-path="url(#75d75e67e1)"><g clip-path="url(#90aa4af11e)"><path fill="#000000" d="M 0.839844 43.222656 L 0.839844 0.4375 L 63.683594 0.4375 L 63.683594 43.222656 Z M 0.839844 43.222656 " fill-opacity="1" fill-rule="nonzero"/></g></g></g></g></g></g></g></svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="w-full lg:w-1/3">
            <div id="scoring-panel" class="relative flex-1 flex flex-col gap-y-4 p-4 lg:p-6 glass-card rounded-2xl">
                
                <div id="pre-game-content"></div>
                <div id="in-game-content"></div>

                <div class="relative w-full h-2.5 progress-bar-container mt-2">
                    <div id="progress-bar-fill" class="progress-bar-fill h-full rounded-full" style="width: 0%;"></div>
                </div>

                <div class="flex justify-center items-center gap-3">
                    <button id="rules-btn" class="flex-1 py-2 px-4 themed-button text-sm" style="color: var(--accent); background: var(--accent-light);">How to Play</button>
                    <button id="new-game-btn" class="flex-1 py-2 px-4 themed-button text-white text-sm" style="background: var(--accent-gradient);">New Game</button>
                </div>

                <div class="text-center">
                    <button id="select-edition-btn" class="w-full py-2 px-4 themed-button text-sm flex items-center justify-center gap-2" style="color: var(--accent); background: var(--accent-light);">
                        Select Game Edition
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <p id="current-edition-display" class="text-xs font-semibold mt-2" style="color: var(--text-secondary);"></p>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="glass-card rounded-xl px-3 py-2">
                        <h3 class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-secondary);">Total Score</h3>
                        <p id="total-score" class="text-2xl font-bold" style="color: var(--accent);">0</p>
                    </div>
                    <div class="glass-card rounded-xl px-3 py-2">
                        <h3 class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-secondary);">High Score</h3>
                        <p id="high-score" class="text-2xl font-bold" style="color: #FFC107;">0</p>
                    </div>
                </div>
                <div id="score-breakdown-card" class="glass-card rounded-xl p-3 text-center">
                    <div class="grid grid-cols-2 gap-2">
                        <div><h3 class="text-xs font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Rows</h3><p id="rows-total-score" class="text-lg font-bold">0</p></div>
                        <div><h3 class="text-xs font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Columns</h3><p id="cols-total-score" class="text-lg font-bold">0</p></div>
                        <div><h3 class="text-xs font-semibold uppercase tracking-wider mt-2" style="color: var(--text-secondary);">Twinning</h3><p id="cross-total-score" class="text-lg font-bold" style="color: #FFC107;">0</p></div>
                        <div><h3 class="text-xs font-semibold uppercase tracking-wider mt-2" style="color: var(--text-secondary);">Grid Bonus</h3><p id="bonus-grid-score" class="text-lg font-bold" style="color: #FFC107;">0</p></div>
                    </div>
                    <div class="border-t border-white/20 mt-2 pt-2">
                        <div class="flex justify-center items-center gap-4">
                             <h3 class="text-xs font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Bomb Squad Charge</h3>
                             <p id="empty-block-penalty" class="text-lg font-bold" style="color: var(--text);">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="rules-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-lg themed-modal p-6 transform scale-95 -translate-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 id="rules-title" class="text-3xl font-bold" style="font-family: 'Pacifico', cursive; color: var(--accent);">How to Play</h2>
                <button id="close-rules-btn" class="w-10 h-10 rounded-full text-xl flex items-center justify-center font-bold">×</button>
            </div>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2" style="color: var(--text-secondary)">
                 <h3 class="font-bold text-lg" style="color: var(--accent);">Gameplay</h3>
                 <ol class="list-decimal list-inside space-y-1">
                    <li>Choose your starting Alloha.</li>
                    <li>Click "Roll Dice" to get two new Allohas.</li>
                    <li>Place both Allohas in any two empty, adjacent (not diagonal) squares.</li>
                    <li>Click the "Select Game Edition" button on the right panel to choose from different game versions with unique scoring patterns.</li>
                </ol>
                 <h3 class="font-bold text-lg" style="color: var(--accent);">Special Powers</h3>
                 <p>Use two different superpowers per game. Each power can only be used once.</p>
                 <ul class="list-disc list-inside space-y-1"><li><b>Past Lives:</b> Undoes your last completed move.</li><li><b>Bomb Bae:</b> Click to activate, then click a stuck block (💣) to fill it with a random Alloha.</li><li><b>No Return:</b> Click to activate, then click any Alloha on the grid to swap it.</li><li><b>Swap Them:</b> Click to activate, then click any two adjacent Allohas to swap their positions. Must be used before you roll the dice.</li></ul>
                 <h3 class="font-bold text-lg" style="color: var(--accent);">Special Blocks</h3>
                 <ul class="list-disc list-inside space-y-1">
                    <li><b>Wild Card (💎):</b> A rare treasure! This special piece acts as any Alloha and can complete any line. Appears once per game.</li>
                    <li><b>Cursed Block (☠️):</b> An immovable obstacle! This block cannot be removed by Bomb Bae or swapped with No Return. Appears once per game.</li>
                 </ul>
                 <h3 class="font-bold text-lg" style="color: var(--accent);">Scoring</h3>
                 <ul class="list-disc list-inside space-y-1"><li><b>3 in a line:</b> 3 points</li><li><b>4 in a line:</b> 8 points</li><li><b>5 in a line:</b> 10 points</li><li><b>6 in a line:</b> 14 points</li><li><b>7 in a line:</b> 20 points</li>
                 <li><b>Twinning Pattern Bonus:</b> Scores on the special highlighted pattern are doubled!</li>
                 <li><b>Grid Bonus:</b> 2x2, 3x3, etc. grids of the same Alloha give bonus points (size * size).</li>
                 <li><b>Penalty:</b> A row or column that can no longer form a 3-symbol sequence gets a -5 penalty. A "dead" line on the twinning pattern gets a -5 penalty.</li></ul>
            </div>
        </div>
    </div>
    
    <div id="edition-select-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-sm themed-modal p-6 transform scale-95 -translate-y-4">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold" style="color: var(--accent);">Select Edition</h2>
                 <button id="close-edition-select-btn" class="w-10 h-10 rounded-full text-xl flex items-center justify-center font-bold">×</button>
            </div>
            <div id="edition-options" class="flex flex-col gap-3"></div>
        </div>
    </div>
    
    <div id="confirm-restart-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-sm themed-modal p-8 text-center transform scale-95 -translate-y-4">
            <h2 class="text-2xl font-bold mb-4" style="color: var(--accent);">Restart Game?</h2>
            <p class="mb-6" style="color: var(--text-secondary);">Your current progress will be lost. Are you sure?</p>
            <div class="flex justify-center items-center gap-3">
                <button id="confirm-cancel-btn" class="flex-1 py-2 px-4 themed-button text-sm" style="color: var(--text-secondary); background: rgba(0,0,0,0.05);">Cancel</button>
                <button id="confirm-restart-btn" class="flex-1 py-2 px-4 themed-button text-white text-sm" style="background: var(--accent-gradient);">Restart</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-md text-center themed-modal p-8 transform scale-95 -translate-y-4 relative">
            <button id="close-game-over-btn" class="absolute top-4 right-4 w-10 h-10 rounded-full text-xl flex items-center justify-center font-bold">×</button>
            <h2 class="text-4xl font-bold mb-2" style="color: var(--accent); font-family: 'Pacifico', cursive;">Game Over!</h2>
            <p id="game-over-reason" class="text-lg mt-2 mb-4" style="color: var(--accent);"></p>
            <p id="final-score-modal" class="text-7xl font-bold my-4" style="color: var(--accent);">0</p>
            <div id="score-breakdown" class="mb-6 p-4 glass-card rounded-xl text-xs">
                <div class="grid grid-cols-2 gap-2">
                    <div class="text-left">Rows: <span id="final-rows-score" class="float-right font-bold">0</span></div>
                    <div class="text-left">Columns: <span id="final-cols-score" class="float-right font-bold">0</span></div>
                    <div class="text-left">Twinning: <span id="final-cross-score" class="float-right font-bold">0</span></div>
                    <div class="text-left">Bonus Grids: <span id="final-bonus-score" class="float-right font-bold">0</span></div>
                    <div class="text-left col-span-2 border-t pt-2 mt-2">Bomb Squad Charge: <span id="final-penalty-score" class="float-right font-bold">0</span></div>
                </div>
            </div>
            <p>High score: <span id="high-score-modal" class="font-bold" style="color: #FFC107;">0</span></p>
            <button id="play-again-btn" class="w-full mt-6 themed-button text-white font-bold py-3 px-4 rounded-xl text-xl" style="background: var(--accent-gradient);">Play Again</button>
        </div>
    </div>

    <div id="exchange-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 invisible z-50 backdrop-blur-sm">
        <div class="modal-content w-full max-w-sm text-center themed-modal p-6 transform scale-95 -translate-y-4">
            <h2 class="text-xl font-bold mb-4" style="color: var(--accent);">Choose a new Alloha</h2>
            <div id="exchange-options" class="grid grid-cols-3 gap-4"></div>
        </div>
    </div>

    <script>
        // --- VARIANT CONFIGURATIONS ---
        const variantConfigs = {
            'core': {
                id: 'core',
                name: 'Cacti Facti Edition',
                title: 'Alloha - Cacti Facti Edition',
                highScoreKey: 'cactiFactiHighScore_core',
                isTwinningCell: (r, c) => {
                    return (r === 3 && c >= 3 && c <= 5) || // 4th Row - Column 4 to 6
                           (r === 5 && c >= 1 && c <= 3) || // 6th Row - Column 2 to 4
                           (c === 1 && r >= 1 && r <= 5) || // 2nd Column - Row 2 to 6
                           (c === 3) ||                     // 4th Column - Entire column
                           (c === 5 && r >= 0 && r <= 3);   // 6th Column - Row 1 to 4
                },
                getCrossScoreSegments: () => [
                    { type: 'row', index: 3, start: 3, end: 5 }, { type: 'row', index: 5, start: 1, end: 3 },
                    { type: 'col', index: 1, start: 1, end: 5 }, { type: 'col', index: 3, start: 0, end: 6 },
                    { type: 'col', index: 5, start: 0, end: 3 }
                ]
            },
            'box_vox': {
                id: 'box_vox',
                name: 'Box Vox Edition',
                title: 'Alloha - Cacti Facti - Box Vox Edition',
                highScoreKey: 'cactiFactiHighScore_box_vox',
                isTwinningCell: (r, c) => {
                    const highlighted = [0, 3, 6]; // Corresponds to rows/cols 1, 4, 7
                    return highlighted.includes(r) || highlighted.includes(c);
                },
                getCrossScoreSegments: () => [
                    { type: 'row', index: 0, start: 0, end: 6 }, { type: 'row', index: 3, start: 0, end: 6 },
                    { type: 'row', index: 6, start: 0, end: 6 }, { type: 'col', index: 0, start: 0, end: 6 },
                    { type: 'col', index: 3, start: 0, end: 6 }, { type: 'col', index: 6, start: 0, end: 6 }
                ]
            },
            'w': {
                id: 'w',
                name: 'W Edition',
                title: 'Alloha - Cacti Facti - W Edition',
                highScoreKey: 'cactiFactiHighScore_w',
                isTwinningCell: (r, c) => {
                    const highlightedCols = [0, 3, 6];
                    return r === 6 || highlightedCols.includes(c);
                },
                getCrossScoreSegments: () => [
                    { type: 'row', index: 6, start: 0, end: 6 }, { type: 'col', index: 0, start: 0, end: 6 },
                    { type: 'col', index: 3, start: 0, end: 6 }, { type: 'col', index: 6, start: 0, end: 6 }
                ]
            }
        };

        class GameState {
            constructor() { this.states = { PRE_GAME: 'PRE_GAME', AWAITING_ROLL: 'AWAITING_ROLL', ANIMATING_ROLL: 'ANIMATING_ROLL', AWAITING_PLACEMENT: 'AWAITING_PLACEMENT', SUPERPOWER_ACTIVE: 'SUPERPOWER_ACTIVE', PROCESSING_TURN: 'PROCESSING_TURN', GAME_OVER: 'GAME_OVER' }; this.currentState = this.states.PRE_GAME; this.validTransitions = { [this.states.PRE_GAME]: [this.states.AWAITING_ROLL], [this.states.AWAITING_ROLL]: [this.states.ANIMATING_ROLL, this.states.PRE_GAME, this.states.SUPERPOWER_ACTIVE, this.states.AWAITING_PLACEMENT], [this.states.ANIMATING_ROLL]: [this.states.AWAITING_PLACEMENT], [this.states.AWAITING_PLACEMENT]: [this.states.PROCESSING_TURN, this.states.AWAITING_ROLL, this.states.SUPERPOWER_ACTIVE], [this.states.SUPERPOWER_ACTIVE]: [this.states.AWAITING_ROLL, this.states.AWAITING_PLACEMENT, this.states.PROCESSING_TURN], [this.states.PROCESSING_TURN]: [this.states.AWAITING_ROLL, this.states.GAME_OVER], [this.states.GAME_OVER]: [this.states.PRE_GAME] }; }
            setState(newState) { if (!this.validTransitions[this.currentState]?.includes(newState)) { console.warn(`Invalid state transition from ${this.currentState} to ${newState}`); return false; } this.currentState = newState; return true; }
            is(state) { return this.currentState === state; }
        }

        class Game {
            constructor(config, savedState = null) {
                this.config = config;
                this.DESERT_SYMBOLS = { 'Hut': '🛖', 'Cactus': '🌵', 'Rock': '🪨', 'Sun': '🌞', 'PalmTree': '🌴', 'Snake': '🐍' };
                this.SPECIAL_SYMBOLS = { 'WILD': '💎', 'CURSED': '☠️' };
                this.SYMBOLS = Object.values(this.DESERT_SYMBOLS);
                this.SYMBOL_COLORS = { '🛖': 'text-amber-700', '🌵': 'text-green-600', '🪨': 'text-gray-500', '🌞': 'text-yellow-400', '🌴': 'text-lime-700', '🐍': 'text-green-700', '💎': 'text-sky-500' };
                this.SCORING_RULES = { 7: 20, 6: 14, 5: 10, 4: 8, 3: 3 };
                this.GRID_SIZE = 7; this.MAX_TURNS = 24; this.CROSS_MULTIPLIER = 2; this.LINE_DEATH_PENALTY = -5; this.CROSS_DEATH_PENALTY = -5; this.MIN_SEQUENCE_LENGTH = 3;
                
                this.gridCells = [];
                this.audio = { unlocked: false, context: null, sounds: new Map() };
                this.DOMElements = this.getDOMElements();
                
                this.init(savedState);
                this.setupEventListeners();
            }

            getDOMElements() {
                const elements = {};
                const idMap = {
                    game_board: 'game-board', row_scores_display: 'row-scores-display',
                    col_scores_display: 'col-scores-display', total_score: 'total-score', high_score: 'high-score',
                    rows_total_score: 'rows-total-score', cols_total_score: 'cols-total-score', cross_total_score: 'cross-total-score',
                    bonus_grid_score: 'bonus-grid-score', empty_block_penalty: 'empty-block-penalty', rules_btn: 'rules-btn',
                    rules_modal: 'rules-modal', close_rules_btn: 'close-rules-btn', game_over_modal: 'game-over-modal',
                    game_over_reason: 'game-over-reason', close_game_over_btn: 'close-game-over-btn',
                    final_score_modal: 'final-score-modal', high_score_modal: 'high-score-modal', play_again_btn: 'play-again-btn',
                    final_rows_score: 'final-rows-score', final_cols_score: 'final-cols-score', final_cross_score: 'final-cross-score',
                    final_bonus_score: 'final-bonus-score', final_penalty_score: 'final-penalty-score',
                    exchange_modal: 'exchange-modal', exchange_options: 'exchange-options', progress_bar_fill: 'progress-bar-fill',
                    new_game_btn: 'new-game-btn', game_board_container: 'game-board-container', scoring_panel: 'scoring-panel',
                    effects_container: 'effects-container', rules_title: 'rules-title', 
                    in_game_content: 'in-game-content', pre_game_content: 'pre-game-content'
                };
                for (const key in idMap) {
                    elements[key] = document.getElementById(idMap[key]);
                }
                return elements;
            }

            init(savedState = null) {
                // Explicitly reset all state variables for a clean slate
                this.gridData = Array(this.GRID_SIZE).fill(null).map(() => Array(this.GRID_SIZE).fill(null));
                this.currentRoll = [];
                this.firstPlacementCell = null;
                this.turnCount = 0;
                this.stuckBlocks = new Set();
                this.usedSuperpowers = new Set();
                this.activeSuperpower = null;
                this.lastGameState = null;
                this.currentTotalScore = 0;
                this.gameStateManager = new GameState();

                if (savedState) {
                    this.gridData = JSON.parse(savedState.gridData);
                    this.currentRoll = savedState.currentRoll;
                    this.firstPlacementCell = savedState.firstPlacementCell;
                    this.turnCount = savedState.turnCount;
                    this.stuckBlocks = new Set(savedState.stuckBlocks);
                    this.usedSuperpowers = new Set(savedState.usedSuperpowers);
                    this.lastGameState = savedState.lastGameState ? { ...savedState.lastGameState, gridData: JSON.parse(savedState.lastGameState.gridData), stuckBlocks: new Set(savedState.lastGameState.stuckBlocks) } : null;
                    this.activeSuperpower = savedState.activeSuperpower;
                    this.currentTotalScore = savedState.currentTotalScore;
                    this.cursedBlockTurn = savedState.cursedBlockTurn;
                    this.wildcardTurn = savedState.wildcardTurn;
                    this.gameStateManager.currentState = savedState.currentState;
                } else {
                    this.cursedBlockTurn = Math.floor(Math.random() * 8) + 5;
                    this.wildcardTurn = Math.floor(Math.random() * 8) + 15;
                    if (this.wildcardTurn === this.cursedBlockTurn) this.wildcardTurn++;
                }

                this.cellToExchange = null; this.swapFirstCell = null;
                
                this.highScore = parseInt(localStorage.getItem(this.config.highScoreKey)) || 0;
                this.DOMElements.high_score.textContent = this.highScore;
                this.DOMElements.rules_title.textContent = this.config.title;

                ['game-over-modal', 'exchange-modal', 'rules-modal'].forEach(id => this.DOMElements[id]?.classList.remove('is-open'));
                
                this.audioInit();
                this.renderGrid();
                this.renderScorePlaceholders();
                this.renderControls();
                this.updateAllScores();
                this.updateProgressBar();
                this.syncPanelHeights();
            }

            getState() {
                return {
                    gridData: JSON.stringify(this.gridData),
                    currentRoll: this.currentRoll,
                    firstPlacementCell: this.firstPlacementCell,
                    turnCount: this.turnCount,
                    stuckBlocks: [...this.stuckBlocks],
                    usedSuperpowers: [...this.usedSuperpowers],
                    lastGameState: this.lastGameState ? { ...this.lastGameState, gridData: JSON.stringify(this.lastGameState.gridData), stuckBlocks: [...this.lastGameState.stuckBlocks] } : null,
                    activeSuperpower: this.activeSuperpower,
                    currentTotalScore: this.currentTotalScore,
                    cursedBlockTurn: this.cursedBlockTurn,
                    wildcardTurn: this.wildcardTurn,
                    currentState: this.gameStateManager.currentState
                };
            }

            audioInit() { this.audioCreateContext(); this.audioCreateSounds(); }
            audioCreateContext() { try { if (!this.audio.context) this.audio.context = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) {} }
            audioCreateSounds() { if (!this.audio.context || this.audio.sounds.size > 0) return; const s = { 'pop': [1200,.1,.05], 'roll': [220,.2,.2], 'hover': [660,.05,.1], 'invalid': [150,.3,.2], 'power-activate': [880,.15,.2], 'power-use': [1047,.2,.3], 'chime': [1047, .15, .2], 'thud': [100, .3, .1] }; for (const k in s) { this.audio.sounds.set(k, ()=>this.audioPlayTone(...s[k])); } }
            audioPlayTone(freq, vol, dur) { if (!this.audio.unlocked || !this.audio.context) return; try { const o = this.audio.context.createOscillator(), g = this.audio.context.createGain(); o.connect(g); g.connect(this.audio.context.destination); o.frequency.value = freq; g.gain.setValueAtTime(0, this.audio.context.currentTime); g.gain.linearRampToValueAtTime(vol*.1, this.audio.context.currentTime+.01); g.gain.exponentialRampToValueAtTime(.001, this.audio.context.currentTime+dur); o.start(); o.stop(this.audio.context.currentTime+dur); } catch (e) {} }
            audioUnlock() { if (this.audio.unlocked) return; document.getElementById('audio-unlocker').play().finally(() => { this.audio.unlocked = true; }); }
            audioPlay(soundName) { this.audio.sounds.get(soundName)?.(); }

            calculateLineScore(line) {
                let totalScore = 0; const usedIndices = new Set();
                for (let len = this.GRID_SIZE; len >= this.MIN_SEQUENCE_LENGTH; len--) {
                    for (let i = 0; i <= this.GRID_SIZE - len; i++) {
                        if ([...Array(len).keys()].some(k => usedIndices.has(i + k))) continue;
                        const slice = line.slice(i, i + len);
                        if (this.isValidSequence(slice)) {
                            totalScore += this.SCORING_RULES[len];
                            for (let k = 0; k < len; k++) {
                                if (slice[k] !== this.SPECIAL_SYMBOLS.WILD) usedIndices.add(i + k);
                            }
                        }
                    }
                }
                if (totalScore === 0 && this.isLineDead(line)) return this.LINE_DEATH_PENALTY;
                return totalScore;
            }
            isValidSequence(slice) {
                if (slice.some(s => s === null)) return false;
                if (!slice.some(s => s !== null)) return false;
                const regularSymbols = slice.filter(s => s && s !== this.SPECIAL_SYMBOLS.WILD);
                return new Set(regularSymbols).size <= 1;
            }
            isLineDead(line) {
                for (let i = 0; i <= line.length - this.MIN_SEQUENCE_LENGTH; i++) {
                    const window = line.slice(i, i + this.MIN_SEQUENCE_LENGTH);
                    if (window.includes(this.SPECIAL_SYMBOLS.CURSED)) continue;
                    const regularSymbols = window.filter(s => s && s !== this.SPECIAL_SYMBOLS.WILD);
                    if (new Set(regularSymbols).size <= 1) return false;
                }
                return true;
            }
            calculateBonusGrids() {
                let points = 0;
                for (let size = this.GRID_SIZE; size >= 2; size--) {
                    for (let r = 0; r <= this.GRID_SIZE - size; r++) {
                        for (let c = 0; c <= this.GRID_SIZE - size; c++) {
                            const first = this.gridData[r][c];
                            if (!first || first === this.SPECIAL_SYMBOLS.CURSED) continue;
                            const subgrid = Array(size).fill(0).map((_, i) => this.gridData[r+i].slice(c, c + size));
                            const flatSubgrid = subgrid.flat();
                            if (flatSubgrid.some(cell => !cell || cell === this.SPECIAL_SYMBOLS.CURSED)) continue;
                            const regularSymbols = flatSubgrid.filter(s => s !== this.SPECIAL_SYMBOLS.WILD);
                            if (new Set(regularSymbols).size <= 1) {
                                points += size * size;
                            }
                        }
                    }
                }
                return points;
            }
            createCellElement(r, c) { const cell = document.createElement('div'); cell.dataset.row = r; cell.dataset.col = c; cell.className = this.getCellClasses(r, c); return cell; }
            getCellClasses(r, c) {
                let classes = 'grid-cell';
                if (this.config.isTwinningCell(r, c)) classes += ' highlighted';
                if (this.stuckBlocks.has(`${r},${c}`)) classes += ' stuck-cell';
                return classes;
            }
            updateCell(cell, r, c) {
                const symbol = this.gridData[r][c];
                cell.className = this.getCellClasses(r, c);
                if (symbol) {
                    cell.textContent = symbol;
                    if(this.SYMBOL_COLORS[symbol]) cell.className += ` ${this.SYMBOL_COLORS[symbol]}`;
                    cell.classList.add('pop-in');
                } else {
                    cell.textContent = this.stuckBlocks.has(`${r},${c}`) ? '💣' : '';
                }
            }
            addCellEventListeners(cell) { cell.addEventListener('click', this.handleCellClick.bind(this)); cell.addEventListener('mouseenter', () => { if (this.gameStateManager.is('AWAITING_PLACEMENT') || this.activeSuperpower) this.audioPlay('hover'); }); }
            syncPanelHeights() { setTimeout(() => { if (window.innerWidth < 1024) return; const boardHeight = this.DOMElements.game_board_container?.getBoundingClientRect().height; if (boardHeight) this.DOMElements.scoring_panel.style.height = `${boardHeight}px`; }, 50); }
            
            updateProgressBar() {
                if (!this.DOMElements.progress_bar_fill) return;
                const percentage = (this.turnCount / this.MAX_TURNS) * 100;
                this.DOMElements.progress_bar_fill.style.width = `${percentage}%`;
            }

            renderGrid() {
                const fragment = document.createDocumentFragment(); this.DOMElements.game_board.innerHTML = ''; this.gridCells = [];
                for (let r = 0; r < this.GRID_SIZE; r++) {
                    const row = [];
                    for (let c = 0; c < this.GRID_SIZE; c++) {
                        const cell = this.createCellElement(r, c); this.updateCell(cell, r, c); this.addCellEventListeners(cell);
                        fragment.appendChild(cell); row.push(cell);
                    }
                    this.gridCells.push(row);
                }
                this.DOMElements.game_board.appendChild(fragment);
            }
            updateFullGrid() { for (let r = 0; r < this.GRID_SIZE; r++) for (let c = 0; c < this.GRID_SIZE; c++) this.updateGridCell(r, c); }
            updateGridCell(r, c) { if (this.gridCells[r]?.[c]) this.updateCell(this.gridCells[r][c], r, c); }
            renderScorePlaceholders() {
                this.DOMElements.row_scores_display.innerHTML = ''; 
                this.DOMElements.col_scores_display.innerHTML = '';
                for (let i = 0; i < this.GRID_SIZE; i++) {
                    const rowScore = document.createElement('div'); rowScore.id = `row-score-${i}`; rowScore.className = 'grid-cell score-display-cell'; rowScore.textContent = '0'; this.DOMElements.row_scores_display.appendChild(rowScore);
                    const colScore = document.createElement('div'); colScore.id = `col-score-${i}`; colScore.className = 'grid-cell score-display-cell'; colScore.textContent = '0'; this.DOMElements.col_scores_display.appendChild(colScore);
                }
            }
            renderControls() {
                if (this.gameStateManager.is('PRE_GAME')) {
                    this.DOMElements.pre_game_content.style.display = 'block';
                    this.DOMElements.in_game_content.style.display = 'none';
                    this.renderSymbolSelector();
                } else {
                    this.DOMElements.pre_game_content.style.display = 'none';
                    this.DOMElements.in_game_content.style.display = 'block';
                    this.renderDiceAndPowers();
                }
            }
            renderSymbolSelector() {
                const container = document.createElement('div'); container.className = 'w-full flex flex-col items-center pt-2';
                container.innerHTML = `<h2 class="text-base lg:text-lg font-semibold text-center mb-4 uppercase tracking-wider" style="color: var(--accent);">CHOOSE YOUR ALLOHA</h2>`;
                const selector = document.createElement('div'); selector.className = 'grid grid-cols-3 gap-2 lg:gap-4';
                this.SYMBOLS.forEach(symbol => {
                    const btn = document.createElement('button');
                    btn.className = `w-16 h-16 rounded-xl text-4xl hover:bg-orange-100/50 ${this.SYMBOL_COLORS[symbol] || ''} flex items-center justify-center transition-transform hover:scale-110 active:scale-95`;
                    btn.textContent = symbol; btn.onclick = () => this.handleSymbolSelect(symbol); btn.onmouseenter = () => this.audioPlay('hover'); selector.appendChild(btn);
                });
                container.appendChild(selector);
                this.DOMElements.pre_game_content.innerHTML = '';
                this.DOMElements.pre_game_content.appendChild(container);
            }
            renderDiceAndPowers() {
                const wrapper = document.createElement('div');
                wrapper.className = 'w-full flex flex-col justify-center gap-3 lg:gap-4 pt-2';
                wrapper.innerHTML = `<div class="flex justify-center items-center gap-2 lg:gap-4"><button id="roll-dice-btn" class="w-14 h-14 lg:w-16 lg:h-16 text-4xl lg:text-5xl flex items-center justify-center" style="color: var(--accent);">🎲</button><div id="dice-1" class="w-14 h-14 lg:w-16 lg:h-16 rounded-xl glass-card flex items-center justify-center text-3xl lg:text-4xl">?</div><div id="dice-2" class="w-14 h-14 lg:w-16 lg:h-16 rounded-xl glass-card flex items-center justify-center text-3xl lg:text-4xl">?</div></div><div class="glass-card rounded-xl px-3 py-4 text-center"><h2 class="text-sm font-semibold uppercase tracking-wider mb-3 flex items-center justify-center gap-2" style="color: var(--text-secondary);">Alloha Power 🪄</h2><div class="grid grid-cols-4 gap-1 text-center"><button id="past-lives-btn" class="superpower-btn"><div>Past</div><div>Lives</div></button><button id="no-return-btn" class="superpower-btn"><div>No</div><div>Return</div></button><button id="bomb-bae-btn" class="superpower-btn"><div>Bomb</div><div>Bae</div></button><button id="swap-them-btn" class="superpower-btn"><div>Swap</div><div>Them</div></button></div></div>`;
                wrapper.querySelector('#roll-dice-btn').onclick = this.handleRollDice.bind(this);
                this.DOMElements.in_game_content.innerHTML = '';
                this.DOMElements.in_game_content.appendChild(wrapper);
                this.updateControlsState();
                this.setupSuperpowerEventListeners(); 
                this.updateSuperpowerButtonsUI();
            }
            updateControlsState() {
                if (this.gameStateManager.is('PRE_GAME')) return;
                const rollBtn = document.getElementById('roll-dice-btn');
                if (rollBtn) rollBtn.disabled = !this.gameStateManager.is('AWAITING_ROLL');
                const dice1 = document.getElementById('dice-1'), dice2 = document.getElementById('dice-2');
                if (!dice1 || !dice2) return;
                if (this.gameStateManager.is('AWAITING_PLACEMENT') && this.currentRoll.length === 2) {
                    dice1.textContent = this.currentRoll[0]; dice1.className = `w-14 h-14 lg:w-16 lg:h-16 rounded-xl glass-card-prominent flex items-center justify-center text-3xl lg:text-4xl ${this.SYMBOL_COLORS[this.currentRoll[0]] || ''}`;
                    dice2.textContent = this.currentRoll[1]; dice2.className = `w-14 h-14 lg:w-16 lg:h-16 rounded-xl glass-card-prominent flex items-center justify-center text-3xl lg:text-4xl ${this.SYMBOL_COLORS[this.currentRoll[1]] || ''}`;
                } else {
                    dice1.textContent = '?'; dice1.className = 'w-14 h-14 lg:w-16 lg:h-16 rounded-xl glass-card flex items-center justify-center text-3xl lg:text-4xl';
                    dice2.textContent = '?'; dice2.className = 'w-14 h-14 lg:w-16 lg:h-16 rounded-xl glass-card flex items-center justify-center text-3xl lg:text-4xl';
                }
            }
            handleSymbolSelect(symbol) { if (!this.gameStateManager.is('PRE_GAME')) return; this.audioUnlock(); this.audioPlay('pop'); this.gridData[0][0] = symbol; this.gameStateManager.setState('AWAITING_ROLL'); this.updateGridCell(0, 0); this.renderControls(); }
            handleRollDice() {
                if (!this.gameStateManager.is('AWAITING_ROLL') || this.gameStateManager.is('GAME_OVER')) return;
                const nextTurn = this.turnCount + 1; let tempRoll;
                if (nextTurn === this.cursedBlockTurn) { this.audioPlay('thud'); tempRoll = [this.SYMBOLS[Math.floor(Math.random() * this.SYMBOLS.length)], this.SPECIAL_SYMBOLS.CURSED]; }
                else if (nextTurn === this.wildcardTurn) { this.audioPlay('chime'); tempRoll = [this.SYMBOLS[Math.floor(Math.random() * this.SYMBOLS.length)], this.SPECIAL_SYMBOLS.WILD]; }
                else { this.audioPlay('roll'); tempRoll = [this.SYMBOLS[Math.floor(Math.random() * this.SYMBOLS.length)], this.SYMBOLS[Math.floor(Math.random() * this.SYMBOLS.length)]]; }
                this.currentRoll = tempRoll.sort(() => Math.random() - 0.5);
                this.gameStateManager.setState('ANIMATING_ROLL'); this.updateControlsState();
                const d1 = document.getElementById('dice-1'), d2 = document.getElementById('dice-2');
                d1.classList.add('dice-tumble'); d2.classList.add('dice-tumble');
                setTimeout(() => {
                    d1.classList.remove('dice-tumble'); d2.classList.remove('dice-tumble');
                    this.gameStateManager.setState('AWAITING_PLACEMENT');
                    this.saveStateForUndo(); 
                    this.updateControlsState(); 
                    this.updateSuperpowerButtonsUI();
                }, 600);
            }
            handleCellClick(e) {
                const cell = e.target.closest('[data-row]'); if (!cell) return;
                const r = parseInt(cell.dataset.row), c = parseInt(cell.dataset.col);
                if (this.activeSuperpower) { this.handleSuperpowerCellClick(r, c, cell); return; }
                if (!this.gameStateManager.is('AWAITING_PLACEMENT')) return;
                if (this.firstPlacementCell) { this.handleSecondPlacement(r, c, cell); } else { this.handleFirstPlacement(r, c); }
            }
            handleFirstPlacement(r, c) { if (!this.gridData[r][c]) { this.gridData[r][c] = this.currentRoll[0]; this.firstPlacementCell = { r, c }; this.updateGridCell(r, c); this.updateSuperpowerButtonsUI(); } }
            handleSecondPlacement(r, c, cell) {
                const { r: pR, c: pC } = this.firstPlacementCell;
                if (pR === r && pC === c) { this.gridData[r][c] = null; this.firstPlacementCell = null; this.updateGridCell(r, c); this.updateSuperpowerButtonsUI(); return; }
                if ((Math.abs(pR - r) + Math.abs(pC - c) === 1) && !this.gridData[r][c]) { this.completeMove(r, c); }
                else { cell.classList.add('shake-animation'); setTimeout(() => cell.classList.remove('shake-animation'), 400); this.audioPlay('invalid'); }
            }
            saveStateForUndo() { this.lastGameState = this.getState(); }
            completeMove(r, c) {
                this.gameStateManager.setState('PROCESSING_TURN');
                this.gridData[r][c] = this.currentRoll[1];
                this.firstPlacementCell = null;
                this.turnCount++;
                this.updateProgressBar();
                this.updateGridCell(r, c);
                this.audioPlay('pop');
                setTimeout(this.processTurnEnd.bind(this), 300);
            }
            processTurnEnd() {
                if (this.gameStateManager.is('GAME_OVER')) return;
                this.detectStuckBlocks(); this.updateAllScores(); 
                if (this.turnCount >= this.MAX_TURNS) { this.endGame("Grid is full!"); return; }
                if (!this.hasValidMoves()) { this.endGame("No valid moves!"); return; }
                this.gameStateManager.setState('AWAITING_ROLL'); this.renderControls();
            }
            endGame(reason = "") {
                if (this.gameStateManager.is('GAME_OVER')) return;
                this.gameStateManager.setState('GAME_OVER'); this.updateAllScores();
                const finalScore = this.currentTotalScore;
                if (finalScore > this.highScore) { this.highScore = finalScore; localStorage.setItem(this.config.highScoreKey, this.highScore); }
                this.DOMElements.game_over_reason.textContent = reason;
                this.DOMElements.final_score_modal.textContent = finalScore;
                this.DOMElements.high_score_modal.textContent = this.highScore;
                this.DOMElements.final_rows_score.textContent = this.DOMElements.rows_total_score.textContent;
                this.DOMElements.final_cols_score.textContent = this.DOMElements.cols_total_score.textContent;
                this.DOMElements.final_cross_score.textContent = this.DOMElements.cross_total_score.textContent;
                this.DOMElements.final_bonus_score.textContent = this.DOMElements.bonus_grid_score.textContent;
                this.DOMElements.final_penalty_score.textContent = this.DOMElements.empty_block_penalty.textContent;
                setTimeout(() => this.DOMElements.game_over_modal.classList.add('is-open'), 500);
            }
            hasValidMoves() { for (let r = 0; r < this.GRID_SIZE; r++) for (let c = 0; c < this.GRID_SIZE; c++) if (!this.gridData[r][c]) { const n = [[-1, 0], [1, 0], [0, -1], [0, 1]]; for (const [dr, dc] of n) { const nr = r + dr, nc = c + dc; if (nr >= 0 && nr < this.GRID_SIZE && nc >= 0 && nc < this.GRID_SIZE && !this.gridData[nr][nc]) return true; } } return false; }
            detectStuckBlocks() { this.stuckBlocks.clear(); for (let r = 0; r < this.GRID_SIZE; r++) for (let c = 0; c < this.GRID_SIZE; c++) if (!this.gridData[r][c]) { const n = [[-1, 0], [1, 0], [0, -1], [0, 1]]; if (n.every(([dr, dc]) => { const nr = r + dr, nc = c + dc; return nr < 0 || nr >= this.GRID_SIZE || nc < 0 || nc >= this.GRID_SIZE || this.gridData[nr][nc] })) this.stuckBlocks.add(`${r},${c}`); } this.updateFullGrid(); }
            updateAllScores() {
                const rS = this.calculateRowScores(), cS = this.calculateColumnScores(), crS = this.calculateCrossScore(), bS = this.calculateBonusGrids();
                this.currentTotalScore = rS.total + cS.total + crS + bS - this.stuckBlocks.size;
                this.updateScoreDisplays(rS.total, cS.total, crS, bS, -this.stuckBlocks.size);
                this.updateIndividualScores(rS.individual, cS.individual);
            }
            calculateRowScores() { let t = 0, ind = []; for (let i = 0; i < this.GRID_SIZE; i++) { const s = this.calculateLineScore(this.gridData[i]); ind.push(s); t += s; } return { total: t, individual: ind }; }
            calculateColumnScores() { let t = 0, ind = []; for (let i = 0; i < this.GRID_SIZE; i++) { const col = this.gridData.map(row => row[i]); const s = this.calculateLineScore(col); ind.push(s); t += s; } return { total: t, individual: ind }; }
            calculateCrossScore() {
                let bonusScore = 0;
                const getScoreForSegment = (segmentSymbols) => {
                    let score = 0; const usedIndices = new Set();
                    for (let len = segmentSymbols.length; len >= this.MIN_SEQUENCE_LENGTH; len--) {
                         for (let i = 0; i <= segmentSymbols.length - len; i++) {
                            if ([...Array(len).keys()].some(k => usedIndices.has(i + k))) continue;
                            const slice = segmentSymbols.slice(i, i + len);
                            if (this.isValidSequence(slice)) {
                                score += this.SCORING_RULES[len] || 0;
                                for (let k = 0; k < len; k++) if (slice[k] !== this.SPECIAL_SYMBOLS.WILD) usedIndices.add(i + k);
                            }
                        }
                    }
                    if (score > 0) return score;
                    if (this.isLineDead(segmentSymbols)) return this.CROSS_DEATH_PENALTY;
                    return 0;
                };
                this.config.getCrossScoreSegments().forEach(seg => {
                    const segmentSymbols = [];
                    for (let i = seg.start; i <= seg.end; i++) {
                        segmentSymbols.push(seg.type === 'row' ? this.gridData[seg.index][i] : this.gridData[i][seg.index]);
                    }
                    bonusScore += getScoreForSegment(segmentSymbols);
                });
                return bonusScore;
            }
            updateScoreDisplays(r, c, cross, b, p) { this.animateScoreUpdate(this.DOMElements.total_score, r + c + cross + b + p); this.animateScoreUpdate(this.DOMElements.rows_total_score, r); this.animateScoreUpdate(this.DOMElements.cols_total_score, c); this.animateScoreUpdate(this.DOMElements.cross_total_score, cross); this.animateScoreUpdate(this.DOMElements.bonus_grid_score, b); this.animateScoreUpdate(this.DOMElements.empty_block_penalty, p); }
            animateScoreUpdate(el, val) { if (!el) return; const startVal = parseInt(el.textContent) || 0; if (startVal === val) return; el.classList.add('score-update'); const duration = 300; let start = null; function step(timestamp) { if (!start) start = timestamp; const progress = Math.min((timestamp - start) / duration, 1); el.textContent = Math.round(startVal + progress * (val - startVal)); if (progress < 1) window.requestAnimationFrame(step); else el.classList.remove('score-update'); } window.requestAnimationFrame(step); }
            updateIndividualScores(rS, cS) { rS.forEach((s, i) => this.updateScoreElement(`row-score-${i}`, s)); cS.forEach((s, i) => this.updateScoreElement(`col-score-${i}`, s)); }
            updateScoreElement(id, score) { const el = document.getElementById(id); if (el) { el.textContent = score; el.classList.toggle('text-red-500', score < 0); } }
            updateSuperpowerButtonsUI() {
                const totalUsed = this.usedSuperpowers.size, isMidMove = this.firstPlacementCell !== null, isPowerActive = this.activeSuperpower !== null, isAwaitingRoll = this.gameStateManager.is('AWAITING_ROLL');
                const btns = { pastLives: document.getElementById('past-lives-btn'), bombBae: document.getElementById('bomb-bae-btn'), noReturn: document.getElementById('no-return-btn'), swapThem: document.getElementById('swap-them-btn') };
                
                if (btns.pastLives) btns.pastLives.disabled = totalUsed >= 2 || this.usedSuperpowers.has('pastLives') || !this.lastGameState || isMidMove || isPowerActive || !isAwaitingRoll;

                if (btns.bombBae) btns.bombBae.disabled = totalUsed >= 2 || this.usedSuperpowers.has('bombBae') || this.stuckBlocks.size === 0 || isMidMove || isPowerActive;
                if (btns.noReturn) btns.noReturn.disabled = totalUsed >= 2 || this.usedSuperpowers.has('noReturn') || isMidMove || isPowerActive;
                if (btns.swapThem) btns.swapThem.disabled = this.turnCount < 1 || totalUsed >= 2 || this.usedSuperpowers.has('swapThem') || !isAwaitingRoll || isMidMove || isPowerActive;
                Object.values(btns).forEach(btn => btn?.classList.remove('superpower-btn--active'));
                if (isPowerActive && btns[this.activeSuperpower]) btns[this.activeSuperpower].classList.add('superpower-btn--active');
                document.body.classList.toggle('cursor-target', this.activeSuperpower === 'bombBae');
            }
            handleSuperpowerCellClick(r, c, cell) {
                if (this.activeSuperpower === 'swapThem') {
                    if (!this.gridData[r][c] || this.gridData[r][c] === this.SPECIAL_SYMBOLS.CURSED) { this.audioPlay('invalid'); return; }
                    if (!this.swapFirstCell) { this.swapFirstCell = { r, c }; cell.classList.add('pulse-animation'); }
                    else {
                        const { r: r1, c: c1 } = this.swapFirstCell;
                        if (r1 === r && c1 === c) { this.swapFirstCell = null; cell.classList.remove('pulse-animation'); return; }
                        if (Math.abs(r1 - r) + Math.abs(c1 - c) === 1) {
                            [this.gridData[r1][c1], this.gridData[r][c]] = [this.gridData[r][c], this.gridData[r1][c1]];
                            this.gridCells[r1][c1].classList.remove('pulse-animation'); this.swapFirstCell = null;
                            this.consumeSuperpower('swapThem'); this.gameStateManager.setState('AWAITING_ROLL'); this.renderControls();
                        } else { this.audioPlay('invalid'); cell.classList.add('shake-animation'); setTimeout(() => cell.classList.remove('shake-animation'), 400); this.gridCells[r1][c1].classList.remove('pulse-animation'); this.swapFirstCell = null; }
                    } return;
                }
                if (this.gridData[r][c] === this.SPECIAL_SYMBOLS.CURSED) { this.audioPlay('invalid'); cell.classList.add('shake-animation'); setTimeout(() => cell.classList.remove('shake-animation'), 400); return; }
                if (this.activeSuperpower === 'bombBae' && this.stuckBlocks.has(`${r},${c}`)) { this.stuckBlocks.delete(`${r},${c}`); this.gridData[r][c] = this.SYMBOLS[Math.floor(Math.random() * this.SYMBOLS.length)]; this.consumeSuperpower('bombBae'); this.gameStateManager.setState('AWAITING_ROLL'); this.renderControls(); }
                else if (this.activeSuperpower === 'noReturn' && this.gridData[r][c]) { this.showSymbolSelectorForExchange(r, c); }
                else { this.audioPlay('invalid'); }
            }
            showSymbolSelectorForExchange(r, c) {
                 this.cellToExchange = {r, c}; this.DOMElements.exchange_options.innerHTML = '';
                 this.SYMBOLS.filter(s => s !== this.gridData[r][c]).forEach(symbol => {
                    const btn = document.createElement('button');
                    btn.className = `w-20 h-20 text-4xl rounded-lg hover:bg-orange-100/50 ${this.SYMBOL_COLORS[symbol] || ''} flex items-center justify-center`;
                    btn.textContent = symbol; btn.onclick = () => this.handleSymbolExchange(symbol); this.DOMElements.exchange_options.appendChild(btn);
                 });
                 this.DOMElements.exchange_modal.classList.add('is-open');
            }
            handleSymbolExchange(newSymbol) {
                if (!this.cellToExchange) return;
                const {r, c} = this.cellToExchange; this.gridData[r][c] = newSymbol;
                this.DOMElements.exchange_modal.classList.remove('is-open'); this.cellToExchange = null;
                this.consumeSuperpower('noReturn'); this.gameStateManager.setState('AWAITING_ROLL'); this.renderControls();
            }
            consumeSuperpower(powerName) {
                this.audioPlay('power-use'); this.usedSuperpowers.add(powerName); this.activeSuperpower = null;
                this.updateFullGrid(); this.updateAllScores(); this.updateSuperpowerButtonsUI();
            }
            setupSuperpowerEventListeners() {
                document.getElementById('past-lives-btn')?.addEventListener('click', () => {
                    if (document.getElementById('past-lives-btn').disabled) return;
                    this.audioPlay('power-activate');

                    const state = this.lastGameState;
                    this.gridData = JSON.parse(state.gridData);
                    this.currentRoll = state.currentRoll;
                    this.firstPlacementCell = state.firstPlacementCell;
                    this.turnCount = state.turnCount;
                    this.stuckBlocks = new Set(state.stuckBlocks);
                    this.gameStateManager.currentState = state.currentState;

                    this.updateFullGrid();
                    this.updateControlsState();
                    this.updateAllScores();
                    this.updateProgressBar();
                    
                    this.consumeSuperpower('pastLives');
                });
                const powerBtns = { bombBae: 'bomb-bae-btn', noReturn: 'no-return-btn', swapThem: 'swap-them-btn' };
                for (const [power, id] of Object.entries(powerBtns)) { document.getElementById(id)?.addEventListener('click', () => { if (document.getElementById(id).disabled) return; this.activeSuperpower = power; this.gameStateManager.setState('SUPERPOWER_ACTIVE'); this.audioPlay('power-activate'); this.updateSuperpowerButtonsUI(); }); }
            }
            setupEventListeners() {
                this.DOMElements.close_rules_btn.addEventListener('click', () => this.DOMElements.rules_modal.classList.remove('is-open'));
                this.DOMElements.close_game_over_btn.addEventListener('click', () => this.DOMElements.game_over_modal.classList.remove('is-open'));
                this.DOMElements.play_again_btn.addEventListener('click', () => { this.DOMElements.game_over_modal.classList.remove('is-open'); gameManager.resetCurrentVariant(); });
                window.addEventListener('resize', this.syncPanelHeights.bind(this));
            }
        }
        
        // --- GAME MANAGER ---
        const gameManager = {
            gameStates: {},
            activeVariantId: null,
            currentGameInstance: null,
            pendingAction: null,

            init() {
                this.populateEditionModal();
                this.setupGlobalEventListeners();
                this.switchVariant('core'); // Default variant
            },

            populateEditionModal() {
                const container = document.getElementById('edition-options');
                container.innerHTML = '';
                Object.values(variantConfigs).forEach(config => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-3 rounded-lg hover:bg-gray-200/50 font-semibold transition-colors';
                    button.textContent = config.name;
                    button.onclick = () => {
                        const game = this.currentGameInstance;
                        const isGameInProgress = game && game.turnCount > 0 && !game.gameStateManager.is('GAME_OVER');
                        
                        document.getElementById('edition-select-modal').classList.remove('is-open');

                        if (isGameInProgress) {
                            this.pendingAction = () => this.switchVariant(config.id, true);
                            document.getElementById('confirm-restart-modal').classList.add('is-open');
                        } else {
                            this.switchVariant(config.id);
                        }
                    };
                    container.appendChild(button);
                });
            },

            switchVariant(variantId, isNewGame = false) {
                const gameContainer = document.getElementById('game-container');
                gameContainer.style.opacity = '0';

                if (this.currentGameInstance && !isNewGame) {
                    this.gameStates[this.activeVariantId] = this.currentGameInstance.getState();
                }

                setTimeout(() => {
                    this.activeVariantId = variantId;
                    const config = variantConfigs[variantId];
                    const savedState = isNewGame ? null : this.gameStates[variantId];
                    
                    if (isNewGame) {
                        delete this.gameStates[variantId];
                    }

                    this.currentGameInstance = new Game(config, savedState);
                    
                    document.getElementById('current-edition-display').textContent = 'Now Playing: ' + config.name;
                    
                    gameContainer.style.opacity = '1';
                }, 250);
            },
            
            resetCurrentVariant() {
                this.switchVariant(this.activeVariantId, true);
            },
            
            setupGlobalEventListeners() {
                const editionModal = document.getElementById('edition-select-modal');
                const confirmModal = document.getElementById('confirm-restart-modal');
                
                document.getElementById('select-edition-btn').addEventListener('click', () => {
                    editionModal.classList.add('is-open');
                });
                document.getElementById('close-edition-select-btn').addEventListener('click', () => editionModal.classList.remove('is-open'));

                document.getElementById('rules-btn').addEventListener('click', () => this.currentGameInstance.DOMElements.rules_modal.classList.add('is-open'));

                document.getElementById('new-game-btn').addEventListener('click', () => {
                    const game = this.currentGameInstance;
                    const isGameInProgress = game && game.turnCount > 0 && !game.gameStateManager.is('GAME_OVER');
                    
                    if (isGameInProgress) {
                        this.pendingAction = () => this.resetCurrentVariant();
                        confirmModal.classList.add('is-open');
                    } else {
                        this.resetCurrentVariant();
                    }
                });

                document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                    this.pendingAction = null;
                    confirmModal.classList.remove('is-open');
                });
                
                document.getElementById('confirm-restart-btn').addEventListener('click', () => {
                    if (typeof this.pendingAction === 'function') {
                        this.pendingAction();
                    }
                    this.pendingAction = null;
                    confirmModal.classList.remove('is-open');
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (this.currentGameInstance?.activeSuperpower) {
                             if (this.currentGameInstance.activeSuperpower === 'swapThem' && this.currentGameInstance.swapFirstCell) {
                                this.currentGameInstance.gridCells[this.currentGameInstance.swapFirstCell.r][this.currentGameInstance.swapFirstCell.c].classList.remove('pulse-animation');
                                this.currentGameInstance.swapFirstCell = null;
                            }
                            this.currentGameInstance.activeSuperpower = null;
                            this.currentGameInstance.updateSuperpowerButtonsUI();
                            this.currentGameInstance.gameStateManager.setState(this.currentGameInstance.firstPlacementCell ? 'AWAITING_PLACEMENT' : 'AWAITING_ROLL');
                        } else {
                           ['rules-modal', 'game-over-modal', 'exchange-modal', 'edition-select-modal', 'confirm-restart-modal'].forEach(id => document.getElementById(id).classList.remove('is-open'));
                        }
                    }
                    if ((e.key === ' ' || e.key === 'Enter') && this.currentGameInstance?.gameStateManager.is('AWAITING_ROLL')) {
                        e.preventDefault();
                        this.currentGameInstance.handleRollDice();
                    }
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            gameManager.init();
        });
    </script>
</body>
</html>
